# =========================
# 1. Base
# =========================
FROM node:23-alpine AS base

RUN apk add --no-cache openssl
WORKDIR /app

# =========================
# 2. Build
# =========================
FROM base AS builder

# Installer turbo
RUN yarn global add turbo

# Copier tout le monorepo
COPY . .

# Installer les d√©pendances
RUN yarn install --frozen-lockfile

# G√©n√©rer Prisma pour la base de donn√©es
RUN yarn workspace @mova_pilates/database db:generate

# Builder uniquement l'API
RUN yarn turbo run build --filter=api...

# =========================
# 3. Production
# =========================
FROM node:23-alpine AS production
ARG PORT=3001
ENV PORT=$PORT

WORKDIR /app
RUN apk add --no-cache openssl

# Cr√©er un user non-root
RUN addgroup --system --gid 1001 nodejs \
  && adduser --system --uid 1001 nestjs
USER nestjs

# Copier le build complet depuis le builder
COPY --from=builder /app .

# üîë Copier explicitement le dossier Prisma du package database (schema + migrations)
COPY --from=builder /app/packages/database/prisma ./packages/database/prisma

EXPOSE $PORT

# Lancer la migration Prisma avec le chemin correct puis d√©marrer l'API
CMD sh -c "npx prisma migrate deploy --schema=packages/database/prisma/schema.prisma && node apps/api/dist/main.js"
